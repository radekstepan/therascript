# Architecture Review Report: Therascript

**Date:** January 19, 2026  
**Scope:** Single-tenant locally-running therapy transcription and AI analysis system  
**Severity Levels:** 游댮 Critical | 游 High | 游리 Medium | 游릭 Low

---

## Executive Summary

Therascript is a well-structured monorepo with clear separation between packages. However, several architectural anti-patterns and potential bugs need attention. The most significant issues are:

1. **Cross-package coupling** via `@therascript/api/dist/*` imports in worker
2. **Multiple conflicting signal handlers** across packages
3. **SQLite statement cache not cleared on close** (memory leak/stale reference bug)
4. **Missing request cancellation/abort plumbing** for long-running operations
5. **Duplicated Ollama streaming implementation** in worker vs API

---

## Table of Contents

1. [Critical Issues](#1-critical-issues)
2. [High Priority Issues](#2-high-priority-issues)
3. [Medium Priority Issues](#3-medium-priority-issues)
4. [Low Priority Issues](#4-low-priority-issues)
5. [Recommendations Summary](#5-recommendations-summary)

---

## 4. Low Priority Issues

### 4.1 游릭 Redis Connection Duplication

**Locations:**
- [`packages/api/src/services/redisConnection.ts`](file:///Users/radek/dev/therascript/packages/api/src/services/redisConnection.ts)
- [`packages/worker/src/redisConnection.ts`](file:///Users/radek/dev/therascript/packages/worker/src/redisConnection.ts)

**Problem:** Both packages define their own Redis connection configuration.

**Recommendation:** Extract to `@therascript/queue` package with connection config and queue names.

---

### 4.2 游릭 Verbose Console Logging

**Problem:** Extensive `console.log` throughout codebase. For a local single-tenant app this is acceptable, but makes log output noisy.

**Recommendation:** Consider a structured logger (pino, winston) with log levels if the application grows.

---

### 4.3 游릭 Missing Analysis Processor Timeout

**Location:** [`packages/worker/src/jobs/analysisProcessor.ts`](file:///Users/radek/dev/therascript/packages/worker/src/jobs/analysisProcessor.ts)

**Problem:** No overall timeout for analysis jobs. A job analyzing many sessions could run for hours.

**Recommendation:** Add configurable job-level timeout (e.g., 30 minutes) and BullMQ job options.

---

## 5. Recommendations Summary

### Immediate Fixes (1-2 hours)

| Issue | Priority | Effort | File |
|-------|----------|--------|------|
| Clear statement cache on DB close | 游댮 Critical | 5 min | `sqliteService.ts` |
| Add HTTP status check in analysis streaming | 游댮 Critical | 10 min | `analysisProcessor.ts` |
| Add Whisper polling timeout | 游리 Medium | 15 min | `transcriptionProcessor.ts` |
| Add ES client close function | 游 High | 20 min | `client.ts` + entrypoints |

### Short-term Refactors (1-2 days)

| Issue | Priority | Effort |
|-------|----------|--------|
| Remove signal handlers from library packages | 游 High | 2-4 hours |
| Centralize shutdown in entrypoints | 游 High | 2-4 hours |
| Create shared Ollama streaming adapter | 游 High | 4-6 hours |

### Medium-term Refactors (1 week)

| Issue | Priority | Effort |
|-------|----------|--------|
| Extract shared packages (@therascript/data, @therascript/domain) | 游댮 Critical | 2-3 days |
| Unify configuration in @therascript/config | 游리 Medium | 1 day |
| Add abort/cancellation plumbing | 游 High | 1-2 days |

---

## Appendix: Affected Files Summary

| Package | Files with Issues |
|---------|-------------------|
| `packages/db` | `sqliteService.ts` |
| `packages/api` | `server.ts`, `jobQueueService.ts`, config |
| `packages/worker` | `index.ts`, `analysisProcessor.ts`, `transcriptionProcessor.ts`, config |
| `packages/elasticsearch-client` | `client.ts` |

---

*Report generated by architecture review on January 19, 2026*
